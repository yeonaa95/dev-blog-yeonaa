// src/lib/auth.ts

/**
 * Firebase Authentication ì„œë¹„ìŠ¤ í•¨ìˆ˜ ëª¨ìŒ
 *
 * Day 1 API ëª…ì„¸ì„œì—ì„œ ì •ì˜í•œ ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ë“¤ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
 * - AUTH-001: ì´ë©”ì¼ íšŒì›ê°€ì…
 * - AUTH-002: ì´ë©”ì¼ ë¡œê·¸ì¸
 * - AUTH-004: ë¡œê·¸ì•„ì›ƒ
 *
 * ğŸ“š ê³µì‹ ë¬¸ì„œ: https://firebase.google.com/docs/auth/web/start
 */

import {
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    signInWithPopup,
    GoogleAuthProvider,
} from "firebase/auth";
import type { User as FirebaseUser, AuthError } from "firebase/auth";
import { auth } from "./firebase";
import type { User } from "@/types";

/**
 * Google Auth Provider
 *
 * Google ë¡œê·¸ì¸ì„ ìœ„í•œ ì¸ì¦ ì œê³µìì…ë‹ˆë‹¤.
 */
const googleProvider = new GoogleAuthProvider();

/**
 * Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ (íŒì—… ë°©ì‹)
 *
 * Day 1 ìš”êµ¬ì‚¬í•­: AUTH-003
 * Day 1 ì‚¬ìš©ì ìŠ¤í† ë¦¬: US-002 (ì†Œì…œ ë¡œê·¸ì¸)
 *
 * ì¸ìˆ˜ ì¡°ê±´:
 * - Google ë¡œê·¸ì¸ ë²„íŠ¼ì´ ìˆë‹¤
 * - í´ë¦­ ì‹œ Google ë¡œê·¸ì¸ íŒì—…ì´ ëœ¬ë‹¤
 * - ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•œë‹¤
 * - ì²˜ìŒ ë¡œê·¸ì¸í•´ë„ ë³„ë„ íšŒì›ê°€ì… ì ˆì°¨ê°€ ì—†ë‹¤
 *
 * ì°¸ê³ : COOP ê²½ê³ ëŠ” ì½˜ì†”ì—ë§Œ í‘œì‹œë˜ë©° ê¸°ëŠ¥ì—ëŠ” ì˜í–¥ ì—†ìŒ
 *
 * @returns ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
 */
export async function signInWithGoogle(): Promise<User> {
    const result = await signInWithPopup(auth, googleProvider);
    return formatUser(result.user);
}

/**
 * Firebase Userë¥¼ ìš°ë¦¬ ì•±ì˜ User íƒ€ì…ìœ¼ë¡œ ë³€í™˜
 *
 * Firebaseê°€ ì œê³µí•˜ëŠ” user ê°ì²´ì—ì„œ í•„ìš”í•œ ì •ë³´ë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
 * Day 1 ë°ì´í„° ëª¨ë¸ì˜ User ì¸í„°í˜ì´ìŠ¤ì— ë§ì¶° ë³€í™˜í•©ë‹ˆë‹¤.
 */
export function formatUser(firebaseUser: FirebaseUser): User {
    return {
        uid: firebaseUser.uid,
        email: firebaseUser.email || "",
        displayName: firebaseUser.displayName,
        photoURL: firebaseUser.photoURL,
    };
}

/**
 * ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ íšŒì›ê°€ì…
 *
 * Day 1 ìš”êµ¬ì‚¬í•­: AUTH-001
 * Day 1 ê¸°ëŠ¥ëª…ì„¸ì„œ: FUNC-001 (íšŒì›ê°€ì…)
 *
 * @param email - ì‚¬ìš©ì ì´ë©”ì¼
 * @param password - ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)
 * @returns ìƒì„±ëœ ì‚¬ìš©ì ì •ë³´
 * @throws ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼, ì•½í•œ ë¹„ë°€ë²ˆí˜¸ ë“±ì˜ ì—ëŸ¬
 */
export async function signUp(email: string, password: string): Promise<User> {
    const userCredential = await createUserWithEmailAndPassword(
        auth,
        email,
        password,
    );
    return formatUser(userCredential.user);
}

/**
 * ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸
 *
 * Day 1 ìš”êµ¬ì‚¬í•­: AUTH-002
 * Day 1 ê¸°ëŠ¥ëª…ì„¸ì„œ: ê¸°ë³¸ íë¦„ ì°¸ê³ 
 *
 * @param email - ì‚¬ìš©ì ì´ë©”ì¼
 * @param password - ë¹„ë°€ë²ˆí˜¸
 * @returns ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
 * @throws ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì, ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ ë“±ì˜ ì—ëŸ¬
 */
export async function signIn(email: string, password: string): Promise<User> {
    const userCredential = await signInWithEmailAndPassword(
        auth,
        email,
        password,
    );
    return formatUser(userCredential.user);
}

/**
 * ë¡œê·¸ì•„ì›ƒ
 *
 * Day 1 ìš”êµ¬ì‚¬í•­: AUTH-004
 */
export async function logout(): Promise<void> {
    await signOut(auth);
}

/**
 * ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
 *
 * Day 1 ìš”êµ¬ì‚¬í•­: AUTH-005 (ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€)
 *
 * Firebase Authì˜ onAuthStateChangedë¥¼ ë˜í•‘í•©ë‹ˆë‹¤.
 * ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì‹œ, ë˜ëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤.
 *
 * @param callback - ì¸ì¦ ìƒíƒœ ë³€ê²½ ì‹œ í˜¸ì¶œë  í•¨ìˆ˜
 * @returns êµ¬ë… í•´ì œ í•¨ìˆ˜ (cleanup)
 */
export function subscribeToAuthState(
    callback: (user: User | null) => void,
): () => void {
    return onAuthStateChanged(auth, (firebaseUser) => {
        if (firebaseUser) {
            callback(formatUser(firebaseUser));
        } else {
            callback(null);
        }
    });
}

/**
 * Firebase Auth ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ì¸ í•œê¸€ë¡œ ë³€í™˜
 *
 * Day 1 ê¸°ëŠ¥ëª…ì„¸ì„œ: ì˜ˆì™¸ íë¦„ì˜ ì‚¬ìš©ì ë©”ì‹œì§€ ì°¸ê³ 
 *
 * @param error - Firebase Auth ì—ëŸ¬ ê°ì²´, ì—ëŸ¬ ì½”ë“œ ë¬¸ìì—´, ë˜ëŠ” unknown íƒ€ì…
 * @returns ì‚¬ìš©ì ì¹œí™”ì ì¸ í•œê¸€ ì—ëŸ¬ ë©”ì‹œì§€
 */
export function getAuthErrorMessage(error: unknown): string {
    const errorMessages: Record<string, string> = {
        // íšŒì›ê°€ì… ì—ëŸ¬
        "auth/email-already-in-use": "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.",
        "auth/invalid-email": "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",
        "auth/weak-password": "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.",

        // ë¡œê·¸ì¸ ì—ëŸ¬
        // ì°¸ê³ : ìµœì‹  FirebaseëŠ” ë³´ì•ˆìƒ user-not-found, wrong-password ëŒ€ì‹ 
        // invalid-credentialì„ ì£¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
        "auth/user-not-found": "ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.",
        "auth/wrong-password": "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        "auth/invalid-credential": "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        "auth/too-many-requests":
            "ë„ˆë¬´ ë§ì€ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",

        // ì¼ë°˜ ì—ëŸ¬
        "auth/network-request-failed": "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
        "auth/internal-error":
            "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
    };

    // ë¬¸ìì—´ë¡œ ì§ì ‘ ì „ë‹¬ëœ ê²½ìš° (ì—ëŸ¬ ì½”ë“œ)
    if (typeof error === "string") {
        return errorMessages[error] || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }

    // AuthError íƒ€ì…ì¸ì§€ í™•ì¸ í›„ ì—ëŸ¬ ì½”ë“œ ì¶”ì¶œ
    if (error && typeof error === "object" && "code" in error) {
        const authError = error as AuthError;
        return (
            errorMessages[authError.code] || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        );
    }

    return "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
}